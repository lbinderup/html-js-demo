<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Airlock Prototype — Topdown v4</title>
<style>
  :root{
    --air:#a8def0; --vac:#1b1f2a; --steel:#3c4657; --ok:#27ae60; --warn:#e67e22; --bad:#c0392b;
    --text:#e8edf2; --muted:#9aa7b5; --door:#b8c0cf; --hold:#ffd166; --shadow:0 8px 20px rgba(0,0,0,0.35);
  }
  html,body{height:100%;background:#0f1218;color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  *{box-sizing:border-box}
  .wrap{max-width:760px;margin:24px auto;padding:16px}
  h1{font-size:18px;margin:0 0 12px 0;font-weight:600;color:#cfe6ff}
  .row{display:grid;grid-template-columns:1fr;gap:16px;align-items:start}
  .ui{background:#0b0e14;border:1px solid #1c2230;border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .legend{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .pill{display:flex;gap:8px;align-items:center;background:#121722;border:1px solid #222a38;border-radius:10px;padding:8px 10px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.air{background:var(--air)}
  .dot.vac{background:var(--vac);outline:1px solid #3c4556}
  .dot.ok{background:var(--ok)}
  .dot.warn{background:var(--warn)}
  .dot.bad{background:var(--bad)}
  .square{width:10px;height:10px;border-radius:2px}
  .square.bad{background:var(--bad)}
  .status{display:grid;gap:6px;margin:8px 0 0 0}
  .status div{background:#121722;border:1px solid #202838;border-radius:10px;padding:8px; min-height: 36px;}
  .hint{color:var(--muted);font-size:12px;margin-top:8px}
  /* Board */
  .board{position:relative;aspect-ratio:16/9;background:#0b0e14;border:1px solid #1c2230;border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
  .grid{position:absolute;inset:12px;display:grid;grid-template-columns:1fr 14px 220px 14px 1fr;gap:0;}
  .zone{position:relative;border:2px solid #2a3548;border-radius:12px;overflow:hidden}
  .zone .label{position:absolute;top:8px;left:10px;font-weight:600;font-size:13px;color:#c6d3e3;text-shadow:0 1px 0 #000;z-index:1}
  .zone.air{background:linear-gradient(180deg, rgba(168,222,240,0.25), rgba(168,222,240,0.1))}
  .zone.vac{background:linear-gradient(180deg, rgba(27,31,42,0.75), rgba(27,31,42,0.35))}
  .airlock{background:linear-gradient(180deg,#1e2533,#141b26);border-color:#3a465b}
  .door-assembly{position:relative;background:var(--steel);border-left:2px solid #202838;border-right:2px solid #202838;}
  /* Double door assemblies */
  .ddoor{position:absolute;inset:20% -8px 20% -8px;z-index:5; pointer-events:none}
  .ddoor .panel{position:absolute;left:50%;width:16px;height:50%;transform:translate(-50%,0);background:var(--door);border:1px solid #c5ccd8;border-radius:3px;box-shadow:inset 0 0 0 2px rgba(255,255,255,0.08),0 2px 6px rgba(0,0,0,0.35);transition:transform 220ms ease}
  .ddoor .panel.top{top:0;transform:translate(-50%,0)}
  .ddoor .panel.bottom{bottom:0;transform:translate(-50%,0)}
  .ddoor.open .panel.top{transform:translate(-50%,-120%)}
  .ddoor.open .panel.bottom{transform:translate(-50%,120%)}
  /* Large click-hit area that never moves */
  .hitbox{position:absolute;inset:20% -12px 20% -12px; z-index:6; cursor:pointer; background:transparent}
  .hitbox.blocked{outline:2px solid var(--bad)}
  /* Cycle buttons */
  .btn{position:absolute;width:24px;height:24px;border-radius:50%;display:grid;place-items:center;cursor:pointer;border:2px solid #2a3140;background:#121722;box-shadow:0 2px 8px rgba(0,0,0,0.3);transition:transform .1s; z-index:4}
  .btn:hover{transform:scale(1.05)}
  .btn .lamp{width:10px;height:10px;border-radius:50%}
  .btn.ok .lamp{background:var(--ok)}
  .btn.warn .lamp{background:var(--warn)}
  .btn.bad .lamp{background:var(--bad)}
  .btn.mid{left:50%;top:14px;transform:translateX(-50%)}
  .btn.left-outside{right:14px;top:50%;transform:translateY(-50%)}
  .btn.right-outside{left:14px;top:50%;transform:translateY(-50%)}
  /* Safety Override Buttons */
  .btn-safety{position:absolute;width:20px;height:20px;border:2px solid #2a3140;background:var(--bad);cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);z-index:4; transition:all .1s ease}
  .btn-safety:hover{transform:scale(1.05)}
  /* When safety is DISABLED (override is ON), button is lit */
  .btn-safety.active{background:#f16152;box-shadow:inset 0 0 6px rgba(255,255,255,0.4), 0 0 10px var(--bad)}
  .btn-safety.mid{left:50%;top:46px;transform:translateX(-50%)}
  .btn-safety.left-outside{right:16px;top:calc(50% + 20px);transform:translateY(-50%)}
  .btn-safety.right-outside{left:16px;top:calc(50% + 20px);transform:translateY(-50%)}
  /* Atmosphere tint inside airlock */
  .tint{position:absolute;inset:0;pointer-events:none;mix-blend-mode:screen;opacity:.35;transition:opacity 220ms ease, background 220ms ease}
  .tint.air{background:var(--air)}
  .tint.vac{background:transparent;opacity:.15}
  /* Air rush */
  .rush{position:absolute;inset:0;pointer-events:none;opacity:0}
  .rush.on{animation:whoosh .7s ease}
  @keyframes whoosh{0%{opacity:0} 10%{opacity:1} 100%{opacity:0}}
  .rush:before{content:""; position:absolute; inset:0; background:
      radial-gradient(120px 40px at 20% 50%, rgba(168,222,240,0.5), transparent 60%),
      radial-gradient(120px 40px at 40% 50%, rgba(168,222,240,0.45), transparent 60%),
      radial-gradient(120px 40px at 60% 50%, rgba(168,222,240,0.4), transparent 60%),
      radial-gradient(120px 40px at 80% 50%, rgba(168,222,240,0.35), transparent 60%);
      filter:blur(2px)}
  /* HUD below preview */
  .hud{background:#0a0f17;border:1px solid #1e2736;border-radius:10px;padding:6px 10px;color:#b9c7d8;font-size:12px;display:flex;flex-wrap:wrap;gap:14px}
  .sep{width:1px;background:#243146}
  .kbd{font:600 11px ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#d8e6f7}
</style>
</head>
<body>
<div class="wrap">
  <h1>Airlock System — Topdown Prototype v4</h1>
  <div class="row">
    <div class="board ui" id="board">
      <div class="grid">
        <div class="zone room-left air" id="roomLeft">
          <div class="label">Left Area <span id="leftTag">(Air)</span></div>
          <div class="btn left-outside" id="btnLeft" title="Cycle airlock"><div class="lamp"></div></div>
          <div class="btn-safety left-outside" id="safetyLeft" title="Toggle safety interlocks"></div>
        </div>
        <div class="door-assembly">
          <div class="ddoor" id="ddLeft"><div class="panel top"></div><div class="panel bottom"></div></div>
          <div class="hitbox" id="hitLeft" title="Left Door"></div>
        </div>
        <div class="zone airlock" id="airlock">
          <div class="label">Airlock <span id="lockTag">(Air)</span></div>
          <div class="tint air" id="lockTint"></div>
          <div class="rush" id="rush"></div>
          <div class="btn mid" id="btnMid" title="Cycle airlock"><div class="lamp"></div></div>
          <div class="btn-safety mid" id="safetyMid" title="Toggle safety interlocks"></div>
        </div>
        <div class="door-assembly">
          <div class="ddoor" id="ddRight"><div class="panel top"></div><div class="panel bottom"></div></div>
          <div class="hitbox" id="hitRight" title="Right Door"></div>
        </div>
        <div class="zone room-right vac" id="roomRight">
          <div class="label">Right Area <span id="rightTag">(Vacuum)</span></div>
          <div class="btn right-outside" id="btnRight" title="Cycle airlock"><div class="lamp"></div></div>
          <div class="btn-safety right-outside" id="safetyRight" title="Toggle safety interlocks"></div>
        </div>
      </div>
    </div>
    <div class="hud ui" id="hud">
      <div>Left: <span class="kbd" id="hudLeft">AIR</span></div><div class="sep"></div>
      <div>Airlock: <span class="kbd" id="hudLock">AIR</span></div><div class="sep"></div>
      <div>Right: <span class="kbd" id="hudRight">VAC</span></div><div class="sep"></div>
      <div>Doors: <span class="kbd" id="hudDoors">L:Closed • R:Closed</span></div><div class="sep"></div>
      <div>Safety: <span class="kbd" id="hudSafety">ACTIVE</span></div>
    </div>
    <div class="ui">
      <div><strong>Rules implemented</strong></div>
      <!-- MODIFIED: Clarified rules for the new equalization behavior -->
      <ul style="margin:6px 0 0 18px">
        <li>Click doors to toggle. Close is always allowed.</li>
        <li>Open requires matching atmospheres OR disabled safety interlocks.</li>
        <li>Forced opening causes immediate pressure equalization.</li>
        <li>A breach to the Right Area (Vacuum) will vent all connected rooms.</li>
        <li>Safety is disabled via the red square buttons.</li>
        <li>Cycle buttons auto-seal doors, wait, then cycle atmosphere.</li>
      </ul>
    </div>
    <div class="ui">
      <div class="legend">
        <div class="pill"><span class="dot air"></span><span>Air</span></div>
        <div class="pill"><span class="dot vac"></span><span>Vacuum</span></div>
        <div class="pill"><span class="dot ok"></span><span>Cycle: Safe</span></div>
        <div class="pill"><span class="dot warn"></span><span>Cycle: Pressurize</span></div>
        <div class="pill"><span class="dot bad"></span><span>Cycle: Vent</span></div>
        <div class="pill"><span class="square bad"></span><span>Safety Override</span></div>
      </div>
      <div class="status"><div id="msg">Ready.</div></div>
      <div class="hint">Disabling safety interlocks allows forced entry but causes pressure equalization.</div>
    </div>
  </div>
</div>

<script>
(function(){
  // --- STATE ---
  const state = {
    leftArea: 'air',
    rightArea: 'vac',
    airlock: 'air',
    doorLeftOpen: false,
    doorRightOpen: false,
  };
  
  let isCycling = false;
  // True means the safety interlock that prevents mismatch-opening is OFF.
  let isSafetyDisabled = false;

  // --- DOM ---
  const el = {
    roomLeft: document.getElementById('roomLeft'), roomRight: document.getElementById('roomRight'),
    airlock: document.getElementById('airlock'), ddLeft: document.getElementById('ddLeft'),
    ddRight: document.getElementById('ddRight'), hitLeft: document.getElementById('hitLeft'),
    hitRight: document.getElementById('hitRight'), btnLeft: document.getElementById('btnLeft'),
    btnMid: document.getElementById('btnMid'), btnRight: document.getElementById('btnRight'),
    lockTint: document.getElementById('lockTint'), rush: document.getElementById('rush'),
    msg: document.getElementById('msg'), safetyBtns: [
      document.getElementById('safetyLeft'), document.getElementById('safetyMid'),
      document.getElementById('safetyRight'), ],
    tags: { left: document.getElementById('leftTag'), right: document.getElementById('rightTag'),
      lock: document.getElementById('lockTag'), },
    hud: { left: document.getElementById('hudLeft'), right: document.getElementById('hudRight'),
      lock: document.getElementById('hudLock'), doors: document.getElementById('hudDoors'),
      safety: document.getElementById('hudSafety'), }
  };

  // --- UTIL ---
  const atmosText = a => a === 'air' ? 'AIR' : 'VAC';
  const setMsg = t => el.msg.textContent = t;
  function triggerRush() {
    el.rush.classList.remove('on');
    void el.rush.offsetWidth; // Reflow
    el.rush.classList.add('on');
  }

  const updateHUD = () => {
    el.hud.left.textContent = atmosText(state.leftArea);
    el.hud.right.textContent = atmosText(state.rightArea);
    el.hud.lock.textContent = atmosText(state.airlock);
    el.hud.doors.textContent = `L:${state.doorLeftOpen?'Open':'Closed'} • R:${state.doorRightOpen?'Open':'Closed'}`;
    if (isSafetyDisabled) {
      el.hud.safety.textContent = 'DISABLED';
      el.hud.safety.style.color = 'var(--bad)';
    } else {
      el.hud.safety.textContent = 'ACTIVE';
      el.hud.safety.style.color = '';
    }
  };

  function render(){
    el.roomLeft.classList.toggle('air', state.leftArea==='air');
    el.roomLeft.classList.toggle('vac', state.leftArea!=='air');
    el.roomRight.classList.toggle('air', state.rightArea==='air');
    el.roomRight.classList.toggle('vac', state.rightArea!=='air');
    el.lockTint.className = 'tint ' + (state.airlock==='air'?'air':'vac');
    el.ddLeft.classList.toggle('open', state.doorLeftOpen);
    el.ddRight.classList.toggle('open', state.doorRightOpen);

    const next = state.airlock==='air' ? 'vac' : 'air';
    const anyMatchAfterCycle = (next===state.leftArea) || (next===state.rightArea);
    const lampClass = anyMatchAfterCycle ? 'ok' : (next==='air'?'warn':'bad');
    [el.btnLeft, el.btnMid, el.btnRight].forEach(b=>{ b.classList.remove('ok','warn','bad'); b.classList.add(lampClass); });
    
    el.safetyBtns.forEach(btn => btn.classList.toggle('active', isSafetyDisabled));
    el.tags.left.textContent = `(${state.leftArea==='air'?'Air':'Vacuum'})`;
    el.tags.right.textContent = `(${state.rightArea==='air'?'Air':'Vacuum'})`;
    el.tags.lock.textContent = `(${state.airlock==='air'?'Air':'Vacuum'})`;
    updateHUD();
  }

  // --- RULES ---
  const canOpenLeft = () => state.airlock === state.leftArea;
  const canOpenRight = () => state.airlock === state.rightArea;

  function checkBreach(){
    // This is the catastrophic failure condition: a path from Air to the external Vacuum.
    if(state.doorLeftOpen && state.doorRightOpen && state.leftArea === 'air'){
      state.leftArea = 'vac';
      state.airlock = 'vac';
      triggerRush();
      setMsg('Breach: All areas vented to vacuum!');
      render();
    }
  }

  function maybeRestoreLeftAirOnSeal(){
    if(!state.doorLeftOpen && !state.doorRightOpen && state.leftArea==='vac'){
      state.leftArea = 'air';
      return true;
    }
    return false;
  }
  
  // MODIFIED: This function now correctly handles pressure equalization.
  function equalizeOnOverride(side) {
    let equalized = false;
    
    if (side === 'left' && state.leftArea !== state.airlock) {
      // If one side has air, it fills the other. Airlock adopts Left Area's pressure.
      const newAtmos = (state.leftArea === 'air' || state.airlock === 'air') ? 'air' : 'vac';
      state.leftArea = newAtmos;
      state.airlock = newAtmos;
      equalized = true;
    } else if (side === 'right' && state.rightArea !== state.airlock) {
      // Right side is a vacuum sink. Anything connected to it becomes vacuum.
      const newAtmos = 'vac'; 
      state.airlock = newAtmos;
      equalized = true;
    }

    if (equalized) {
      triggerRush();
      setMsg("Pressure equalized between rooms.");
      render();
    }
  }

  function toggleSafetyOverride(){
    isSafetyDisabled = !isSafetyDisabled;
    if (isSafetyDisabled) {
      setMsg('Warning: Safety interlocks DISABLED. Mismatched doors will equalize pressure.');
    } else {
      setMsg('Safety interlocks ACTIVE.');
    }
    render();
  }

  function toggleAirlock(){
    if (isCycling) return; isCycling = true;
    const performCycle = () => {
      state.airlock = (state.airlock === 'air') ? 'vac' : 'air';
      setMsg(`Airlock cycled: now ${state.airlock === 'air' ? 'Air' : 'Vacuum'}.`);
      render(); isCycling = false;
    };
    if (state.doorLeftOpen || state.doorRightOpen) {
      state.doorLeftOpen = false;
      state.doorRightOpen = false;
      maybeRestoreLeftAirOnSeal();
      setMsg('Sealing airlock for cycle...');
      render(); setTimeout(performCycle, 300);
    } else { performCycle(); }
  }

  function setupDoor(hitEl, side){
    hitEl.addEventListener('click', () => {
      hitEl.classList.remove('blocked');
      const isOpen = (side === 'left') ? state.doorLeftOpen : state.doorRightOpen;

      if (isOpen) { // --- Handle CLOSING a door ---
        if (side === 'left') { state.doorLeftOpen = false;
          if (maybeRestoreLeftAirOnSeal()) { setMsg('Left door closed. Area re-pressurized.'); } 
          else { setMsg('Left door closed.'); }
        } else { state.doorRightOpen = false; setMsg('Right door closed.'); }
        render(); return;
      }
      
      // --- Handle OPENING a door ---
      const canOpenNormally = (side === 'left') ? canOpenLeft() : canOpenRight();
      const usingOverride = !canOpenNormally && isSafetyDisabled;

      if (canOpenNormally || isSafetyDisabled) {
        if (side === 'left') { state.doorLeftOpen = true; } 
        else { state.doorRightOpen = true; }
        setMsg(usingOverride ? `Forcing ${side} door open...` : `${side.charAt(0).toUpperCase() + side.slice(1)} door opened.`);
        render();

        if (usingOverride) { equalizeOnOverride(side); }
        checkBreach(); // Always check for a full breach after any door opens.
        
      } else { // Blocked
        hitEl.classList.add('blocked');
        setMsg('Blocked: Atmosphere mismatch. Disable safety to force open.');
        setTimeout(() => hitEl.classList.remove('blocked'), 700);
      }
    });
  }

  // --- Wire everything up ---
  setupDoor(el.hitLeft, 'left');
  setupDoor(el.hitRight, 'right');
  [el.btnLeft, el.btnMid, el.btnRight].forEach(b => b.addEventListener('click', toggleAirlock));
  el.safetyBtns.forEach(b => b.addEventListener('click', toggleSafetyOverride));

  // Initial render
  render();
  setMsg("Airlock simulation ready.");
})();
</script>
</body>
</html>
